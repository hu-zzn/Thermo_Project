<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Biodiesel Exergy Calculator ‚Äî Full</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas (for capturing chart) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f4f4f4; --card:#ffffff; --primary:#4F4557; --muted:#6D5D6E; --accent:#393646; --text:#222;
      --soft:#F4EEE0;
    }
    .dark{
      --bg:#1f1b23; --card:#2b2730; --primary:#bfb7c0; --muted:#d6cfe0; --accent:#F4EEE0; --text:#F4EEE0; --soft:#393646;
    }
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);}
    header{background:var(--accent);color:var(--soft);padding:18px 12px;text-align:center}
    main{max-width:980px;margin:18px auto;padding:16px}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:14px}
    label{display:block;font-weight:600;margin-top:8px;color:var(--muted)}
    input[type="number"], select, input[type="text"]{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;margin-top:6px;background:transparent;color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .btn{background:var(--primary);color:var(--soft);padding:10px 12px;border:none;border-radius:8px;cursor:pointer;margin-top:10px}
    .btn.secondary{background:transparent;color:var(--primary);border:1px solid var(--primary)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .small{font-size:0.9rem;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:center}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .topline{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .muted{color:var(--muted);font-size:0.9rem}
    body.dark .submission-section {
        background: var(--card);
        color: var(--text);
    }
    footer{color:var(--muted);text-align:center;margin:10px 0}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1 style="margin:0">Biodiesel Engine Exergy Calculator</h1>
      <div class="small">Compare BTE, Exergy Efficiency & BSFC across blends ‚Äî download PDF with chart & your name</div>
    </header>

    <main>
      <div class="card">
        <div class="topline">
          <div>
            <label for="blendRange">Fuel Blend (Biodiesel %)</label>
            <input type="range" id="blendRange" min="0" max="100" step="1" value="0" oninput="blendLabel.textContent = 'B' + this.value">
            <div id="blendLabel" style="font-weight:600; color:var(--muted);">B0</div>
          </div>
          <div style="width:220px">
            <label for="username">Your name (for PDF)</label>
            <input id="username" type="text" placeholder="e.g., Hussain Abbas Zaidi" />
          </div>
          <div style="width:160px">
            <label style="visibility:hidden">toggle</label>
            <button id="darkToggle" class="btn secondary">Toggle Dark Mode</button>
          </div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div><label for="rpm">Engine Speed (RPM)</label><input id="rpm" type="number" value="1500" /></div>
          <div><label for="torque">Torque (N¬∑m)</label><input id="torque" type="number" value="20" /></div>
          <div><label for="fuel">Fuel Flow (kg/s)</label><input id="fuel" type="number" value="0.000021" step="0.000001" /></div>
          <div><label for="texh">Exhaust Temp (K)</label><input id="texh" type="number" value="673" /></div>
          <div><label for="t0">Ambient Temp (K)</label><input id="t0" type="number" value="298" /></div>
          <div><label for="inj">Injection Timing (¬∞CA)</label><input id="inj" type="number" value="0" /></div>
          <div><label for="density">Density (kg/m¬≥)</label><input id="density" type="number" value="860" /></div>
          <div><label for="cetane">Cetane Number</label><input id="cetane" type="number" value="48" step="0.1" /></div>
          <div><label for="viscosity">Viscosity (cSt)</label><input id="viscosity" type="number" value="3.5" step="0.1" /></div>
          <div><label for="carbon">Carbon (% by mass)</label><input id="carbon" type="number" value="77" step="0.1" /></div>
          <div><label for="hydrogen">Hydrogen (% by mass)</label><input id="hydrogen" type="number" value="12" step="0.1" /></div>
          <div><label for="oxygenElem">Oxygen (% by mass)</label><input id="oxygenElem" type="number" value="10" step="0.1" /></div>
          <div><label for="pourPoint">Pour Point (¬∞C)</label><input id="pourPoint" type="number" value="-3" /></div>
        </div>

        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="addBtn">Add to Graph</button>
          <button class="btn secondary" id="calcBtn">Calculate (show single)</button>
          <button class="btn secondary" id="clearBtn">Clear Graph</button>
          <button class="btn" id="downloadBtn">Download PDF (With Graph & Name)</button>
        </div>

        <div id="singleResult" class="small muted" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3 style="margin:0">Comparison Chart</h3>
        <canvas id="effChart" style="max-height:420px"></canvas>
        <div class="small muted">Note: add multiple blends/operating points with "Add to Graph". Click Download PDF to export.</div>
      </div>

      <div class="card">
        <h3 style="margin:0">Data Table (added rows)</h3>
        <div style="overflow:auto;max-height:260px">
          <table id="dataTable">
            <thead><tr><th>#</th><th>Blend</th><th>RPM</th><th>Torque (N¬∑m)</th><th>Fuel (kg/s)</th><th>BTE %</th><th>Exergy %</th><th>BSFC (g/kWh)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <footer>Built for biodiesel exergy studies ‚Ä¢ Saves chart image into PDF ‚Ä¢ Use responsibly</footer>
        <!-- Submission Details Section -->
        <div class="card submission-section">
        <h3 style="margin:0 0 10px 0;font-weight:700;text-decoration:underline;">
            Submitted by:
        </h3>
        <p style="margin:4px 0;">Abhinav Jha&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: 2024/AE/002</p>
        <p style="margin:4px 0;">Hussain Abbas Zaidi&nbsp;: 2024/AE/030</p>
        <p style="margin:4px 0;">Kunal Tegwal&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: 2024/AE/034</p>

        <h3 style="margin:18px 0 6px 0;font-weight:700;">Submitted to:</h3>
        <p style="margin:4px 0;font-weight:700;">Prof. R. S. Mishra</p>
        <p style="margin:4px 0;">Department of Mechanical Engineering</p>
        </div>
    </main>
  </div>

<script>
(() => {
  // Function to calculate LHV dynamically
  function calculateLHV(blendPercent) {
    const LHV_diesel = 42500;  // kJ/kg
    const LHV_biodiesel = 37500; // kJ/kg
    const fraction = blendPercent / 100;
    return LHV_diesel * (1 - fraction) + LHV_biodiesel * fraction;
  }

  const rows = []; // Data storage for table + chart

  // Chart setup
  const ctx = document.getElementById('effChart').getContext('2d');
  const chartData = { 
    labels: [], 
    datasets: [
      { label: 'Brake Thermal Efficiency (%)', data: [], backgroundColor: '#6D5D6E' },
      { label: 'Exergy Efficiency (%)', data: [], backgroundColor: '#4F4557' }
    ]
  };
  const chartOptions = { 
    responsive:true, 
    scales:{ y:{ beginAtZero:true, max:100 } }, 
    plugins:{ title:{ display:true, text:'Efficiency vs Blend/Run' } } 
  };
  const effChart = new Chart(ctx, { type:'bar', data: chartData, options: chartOptions });

  // Main metric calculations
function calcMetrics({ blend, rpm, torque, mFuel }) {
  if (!rpm || !torque || !mFuel || mFuel <= 0)
    throw new Error('Enter valid RPM, torque, and fuel flow rate.');

  // üîπ Automatically calculate LHV (based on biodiesel-diesel blend)
  // Typical biodiesel composition (C=77%, H=12%, O=10%)
  // Dulong‚Äôs formula: LHV = 338.2C + 1442(H - O/8)
  // Interpolate linearly for biodiesel-diesel blend
  const C_diesel = 86, H_diesel = 13, O_diesel = 1;     // Diesel composition (%)
  const C_biodiesel = 77, H_biodiesel = 12, O_biodiesel = 10; // Biodiesel composition (%)

  const x = blend / 100; // biodiesel fraction
  const C = C_diesel * (1 - x) + C_biodiesel * x;
  const H = H_diesel * (1 - x) + H_biodiesel * x;
  const O = O_diesel * (1 - x) + O_biodiesel * x;

  const LHV = 338.2 * C + 1442 * (H - O / 8); // kJ/kg auto-calculated
  // Example: for B20 ‚Üí ~41500 kJ/kg automatically

  // 1Ô∏è‚É£ Brake Power (kW)
  const BP = (2 * Math.PI * rpm * torque) / 600000;

  // 2Ô∏è‚É£ Fuel Energy Input Rate (kW)
  const Ef = mFuel * LHV;

  // 3Ô∏è‚É£ Brake Thermal Efficiency (%)
  const BTE = (BP / Ef) * 100;

  // 4Ô∏è‚É£ Fuel Chemical Exergy (kW)
  const Ex_fuel = 1.04 * Ef;

  // 5Ô∏è‚É£ Exergy Efficiency (%)
  const Ex_eff = (BP / Ex_fuel) * 100;

  // 6Ô∏è‚É£ Exergy Loss (kW)
  const Ex_loss = Ex_fuel - BP;

  // 7Ô∏è‚É£ BSFC (g/kWh)
  const BSFC_g_per_kWh = BP > 0 ? (mFuel / BP) * 3600 * 1000 : Infinity;

  // 8Ô∏è‚É£ Exergy Destruction Fraction (%)
  const Ex_destruction_frac = (Ex_loss / Ex_fuel) * 100;

  // 9Ô∏è‚É£ Emission Estimates (trend-based approximation)
  const NOx = 0.25 * Ex_eff;
  const CO = 0.15 * (100 - BTE);
  const CO2 = (mFuel * 44 / 12) * 3600;

  return { BP, Ef, BTE, Ex_fuel, Ex_eff, Ex_loss, BSFC_g_per_kWh, Ex_destruction_frac, NOx, CO, CO2 };
}

  // Add a new row to table
  function addRowToTable(index, blend, rpm, torque, mFuel, metrics) {
    const tbody = document.querySelector('#dataTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${index}</td>
      <td>B${blend}</td>
      <td>${rpm}</td>
      <td>${torque}</td>
      <td>${mFuel.toExponential(3)}</td>
      <td>${metrics.BTE.toFixed(2)}</td>
      <td>${metrics.Ex_eff.toFixed(2)}</td>
      <td>${isFinite(metrics.BSFC_g_per_kWh)?metrics.BSFC_g_per_kWh.toFixed(0):'‚Äî'}</td>
    `;
    tbody.appendChild(tr);
  }

  // Update chart data
  function updateChart() {
    chartData.labels = rows.map((r,i)=>`#${i+1} B${r.blend}`);
    chartData.datasets[0].data = rows.map(r=>r.metrics.BTE);
    chartData.datasets[1].data = rows.map(r=>r.metrics.Ex_eff);
    effChart.update();
  }

  // DOM elements
  const blendEl = document.getElementById('blendRange');
  const rpmEl = document.getElementById('rpm');
  const torqueEl = document.getElementById('torque');
  const fuelEl = document.getElementById('fuel');
  const texhEl = document.getElementById('texh');
  const t0El = document.getElementById('t0');
  const usernameEl = document.getElementById('username');
  const singleResult = document.getElementById('singleResult');

  // Add to graph
  document.getElementById('addBtn').addEventListener('click', () => {
    try {
      const data = {
        blend: parseFloat(blendEl.value),
        rpm: parseFloat(rpmEl.value),
        torque: parseFloat(torqueEl.value),
        mFuel: parseFloat(fuelEl.value),
        T_exh: parseFloat(texhEl.value),
        T0: parseFloat(t0El.value)
      };
      const metrics = calcMetrics(data);
      rows.push({ ...data, metrics });
      addRowToTable(rows.length, data.blend, data.rpm, data.torque, data.mFuel, metrics);
      updateChart();
      singleResult.innerHTML = `<b>Added:</b> B${data.blend} ‚Äî BP ${metrics.BP.toFixed(2)} kW ‚Ä¢ BTE ${metrics.BTE.toFixed(2)}% ‚Ä¢ Exergy ${metrics.Ex_eff.toFixed(2)}% ‚Ä¢ Exergy Loss ${metrics.Ex_loss.toFixed(2)} kW ‚Ä¢ BSFC ${metrics.BSFC_g_per_kWh.toFixed(0)} g/kWh ‚Ä¢ NOx ${metrics.NOx.toFixed(2)} g/kWh`;
    } catch (e) { alert('Error: ' + e.message); }
  });

  // Single calc
  document.getElementById('calcBtn').addEventListener('click', () => {
    try {
      const data = {
        blend: parseFloat(blendEl.value),
        rpm: parseFloat(rpmEl.value),
        torque: parseFloat(torqueEl.value),
        mFuel: parseFloat(fuelEl.value),
        T_exh: parseFloat(texhEl.value),
        T0: parseFloat(t0El.value)
      };
      const metrics = calcMetrics(data);
      singleResult.innerHTML = `<b>Single calc:</b> B${data.blend} ‚Äî Brake Power ${metrics.BP.toFixed(3)} kW ‚Ä¢ BTE ${metrics.BTE.toFixed(2)}% ‚Ä¢ Exergy ${metrics.Ex_eff.toFixed(2)}% ‚Ä¢ Exergy Loss ${metrics.Ex_loss.toFixed(2)} kW ‚Ä¢ BSFC ${metrics.BSFC_g_per_kWh.toFixed(0)} g/kWh ‚Ä¢ NOx ${metrics.NOx.toFixed(2)} g/kWh`;
    } catch (e) { alert('Error: ' + e.message); }
  });

  // Clear chart/table
  document.getElementById('clearBtn').addEventListener('click', () => {
    rows.length = 0;
    document.querySelector('#dataTable tbody').innerHTML = '';
    updateChart();
    singleResult.innerHTML = 'Graph cleared.';
  });

  // Dark mode toggle
  document.getElementById('darkToggle').addEventListener('click', () => {
    document.body.classList.toggle('dark');
  });

  // PDF download
  document.getElementById('downloadBtn').addEventListener('click', async () => {
    if (rows.length === 0) { alert('Add at least one run before downloading PDF.'); return; }
    const username = usernameEl.value.trim() || 'Anonymous';
    let chartImageData = effChart.toBase64Image();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
    const margin = 40;
    const pageWidth = doc.internal.pageSize.getWidth();

    doc.setFontSize(18);
    doc.text('Biodiesel Engine Exergy Report', pageWidth / 2, margin + 10, { align: 'center' });
    doc.setFontSize(10);
    doc.text(`Prepared by: ${username}`, margin, margin + 40);
    doc.text(`Date: ${new Date().toLocaleString()}`, margin, margin + 55);

    const chartW = pageWidth - margin * 2;
    doc.addImage(chartImageData, 'PNG', margin, margin + 70, chartW, 220);

    doc.setFontSize(11);
    const startY = margin + 320;
    doc.text('Summary of Runs:', margin, startY);
    let y = startY + 15;
    doc.setFontSize(9);
    rows.forEach((r, i) => {
      doc.text(`#${i+1} B${r.blend} | BP ${r.metrics.BP.toFixed(2)} kW | BTE ${r.metrics.BTE.toFixed(2)}% | Exergy ${r.metrics.Ex_eff.toFixed(2)}% | BSFC ${r.metrics.BSFC_g_per_kWh.toFixed(0)} g/kWh | Exergy Loss ${r.metrics.Ex_loss.toFixed(2)} kW | NOx ${r.metrics.NOx.toFixed(2)} g/kWh`, margin, y);
      y += 12;
      if (y > 760) { doc.addPage(); y = 60; }
    });

    doc.setFontSize(8);
    doc.text('Notes: Exergy ‚âà 1.04√óLHV; BSFC = (m_fuel/BP)*3600; Emissions are approximate trends.', margin, doc.internal.pageSize.getHeight() - 40);

    doc.save(`Exergy_Report_${username.replace(/\s+/g,'_')}.pdf`);
  });

})();
</script>
</body>
</html>
